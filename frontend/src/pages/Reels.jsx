import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { SparklesCore } from '../components/ui/sparkles';
import { GlowingEffect } from '../components/ui/GlowingEffect';
import LeftPanel from '../components/home/LeftPanel';
import { 
  ChevronUp, 
  ChevronDown, 
  Heart, 
  MessageCircle, 
  Share2, 
  Plus, 
  Music, 
  User,
  ArrowLeft,
  Upload,
  X,
  Video,
  Camera,
  AlertCircle,
  VolumeX,
  Volume2,
  MoreVertical,
  Send,
  Trash,
  Copy,
  Link
} from 'lucide-react';
import axios from 'axios';
import { useAuth } from '../context/AuthContext';
import { API_URL, DEFAULT_VIDEO_THUMBNAIL } from '../config/constants';
import { toast, Toaster } from 'react-hot-toast';

// Komponentleri i√ße aktar
import ReelsVideoPlayer from '../components/reels/ReelsVideoPlayer';
import VideoControls from '../components/reels/VideoControls';
import CommentsPanel from '../components/reels/CommentsPanel';
import ReelsHeader from '../components/reels/ReelsHeader';
import VideoUploader from '../components/reels/VideoUploader';

// Utility function to convert boolean attributes to strings
const convertBooleanProps = (props) => {
  const result = { ...props };
  const attributesToConvert = ['jsx', 'global'];
  
  attributesToConvert.forEach(attr => {
    if (attr in result && typeof result[attr] === 'boolean') {
      result[attr] = result[attr].toString();
    }
  });
  
  return result;
};

// Video uzantƒ±sƒ± i√ßin izin verilen dosya t√ºrleri
const ALLOWED_VIDEO_TYPES = ['video/mp4', 'video/webm', 'video/quicktime', 'video/x-msvideo'];
// Maksimum dosya boyutu (20MB)
const MAX_FILE_SIZE = 20 * 1024 * 1024;

// Yedek video verisi - API'den veri √ßekilemediƒüinde g√∂sterilir
const FALLBACK_REELS = [
  {
    id: '1',
    user: {
      username: 'ahmetk',
      profileImage: 'https://randomuser.me/api/portraits/men/32.jpg',
    },
    videoURL: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
    caption: 'Yeni dans rutini #dans #m√ºzik',
    likeCount: 1204,
    commentCount: 89,
    shareCount: 32,
    music: '≈ûarkƒ± - Sanat√ßƒ± Adƒ±',
    isLiked: false,
  },
  {
    id: '2',
    user: {
      username: 'melisaz',
      profileImage: 'https://randomuser.me/api/portraits/women/44.jpg',
    },
    videoURL: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
    caption: 'Yaz tatili ba≈ülasƒ±n #yaz #havuz #tatil',
    likeCount: 2530,
    commentCount: 112,
    shareCount: 45,
    music: 'Yaz ≈ûarkƒ±sƒ± - Pop Yƒ±ldƒ±zƒ±',
    isLiked: false,
  },
];

// √ñrnek yorum verileri
const SAMPLE_COMMENTS = [
  {
    id: 1,
    user: {
      username: 'AhmetArslan-j5m',
      profileImage: 'https://randomuser.me/api/portraits/men/32.jpg',
    },
    text: 'Yanlƒ±≈üƒ±m varsa d√ºzeltin ama manwa\'da da durum b√∂yleydi parkta izleyip, yer deƒüi≈ü tekniƒüi ile gidiyordu. Novel\'i okumadƒ±m bilmiyorum.',
    likeCount: 15,
    timestamp: '8 saat √∂nce'
  },
  {
    id: 2,
    user: {
      username: 'ramiznifteliyev6083',
      profileImage: 'https://randomuser.me/api/portraits/men/43.jpg',
    },
    text: 'Benim bildiƒüim kadarƒ±yla g√∂lgeleri kamera gibi kullanma √∂zelliƒüini sonradan kazanƒ±yordu, hatta bu √∂zelliƒüi test ederken Cha Hae in\'i banyo yaparken yakalamƒ±≈ütƒ±',
    likeCount: 13,
    timestamp: '8 saat √∂nce (d√ºzenlendi)'
  },
  {
    id: 3,
    user: {
      username: 'ahmetbro4890',
      profileImage: 'https://randomuser.me/api/portraits/men/55.jpg',
    },
    text: 'Animedeki √ßok daha mantƒ±klƒ± olmu≈ü ger√ßekten',
    likeCount: 0,
    timestamp: '5 saat √∂nce'
  }
];

// Mesaj √ßubuƒüu bile≈üeni
const AuthRequiredBanner = ({ onLogin }) => (
  <motion.div
    className="fixed top-0 left-0 right-0 p-4 bg-gradient-to-r from-purple-500 to-blue-500 text-white z-50"
    initial={{ y: -100 }}
    animate={{ y: 0 }}
    transition={{ type: 'spring', stiffness: 500, damping: 25 }}
  >
    <div className="flex items-center justify-between max-w-4xl mx-auto">
      <p className="text-sm md:text-base">
        Reels'i tam olarak deneyimlemek i√ßin giri≈ü yapƒ±n
      </p>
      <motion.button
        className="px-4 py-2 bg-white text-purple-600 rounded-full text-sm font-medium"
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
        onClick={onLogin}
      >
        Giri≈ü Yap
      </motion.button>
    </div>
  </motion.div>
);

// Sol panele eklenecek se√ßici bile≈üeni
const TabSelector = ({ activeTab, setActiveTab }) => {
  return (
    <div className="bg-slate-800/50 backdrop-blur-sm rounded-xl p-3 mt-4">
      <h3 className="text-sm font-medium mb-3 text-white/70">Reels ƒ∞√ßerikleri</h3>
      <div className="flex flex-col space-y-2">
        <button
          onClick={() => setActiveTab('following')}
          className={`flex items-center px-3 py-2 rounded-lg transition-colors ${
            activeTab === 'following'
              ? 'bg-purple-500/20 text-purple-400 border-l-2 border-purple-500'
              : 'text-white/70 hover:bg-slate-700/50'
          }`}
        >
          <svg className="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <span>Takip Ettiklerim</span>
        </button>
        
        <button
          onClick={() => setActiveTab('explore')}
          className={`flex items-center px-3 py-2 rounded-lg transition-colors ${
            activeTab === 'explore'
              ? 'bg-purple-500/20 text-purple-400 border-l-2 border-purple-500'
              : 'text-white/70 hover:bg-slate-700/50'
          }`}
        >
          <svg className="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>Ke≈üfet</span>
        </button>
      </div>
    </div>
  );
};

const Reels = () => {
  const navigate = useNavigate();
  const { user, token } = useAuth();
  const [currentReelIndex, setCurrentReelIndex] = useState(0);
  const [activeTab, setActiveTab] = useState('explore');
  const [reels, setReels] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const reelsContainerRef = useRef(null);
  const [showCommentsPanel, setShowCommentsPanel] = useState(false);
  const [activeReelId, setActiveReelId] = useState(null);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [showSearchInput, setShowSearchInput] = useState(false);
  const [likedReels, setLikedReels] = useState({});
  const lastTouchY = useRef(null);
  const touchStartTime = useRef(null);
  const isScrolling = useRef(false);
  const lastScrollTime = useRef(0);
  
  // API isteƒüi √∂ncesi token kontrol√º yapmak i√ßin yardƒ±mcƒ± fonksiyon
  const secureApiRequest = useCallback(async (requestFn, fallbackValue = null) => {
    if (!token) {
      toast.error('Bu i≈ülem i√ßin giri≈ü yapmanƒ±z gerekiyor');
      return fallbackValue;
    }
    
    try {
      return await requestFn();
    } catch (err) {
      if (err.response && err.response.status === 401) {
        toast.error('Oturum s√ºresi doldu, l√ºtfen tekrar giri≈ü yapƒ±n');
        navigate('/login');
      }
      throw err;
    }
  }, [token, navigate]);

  // API'den reels verilerini getir
  const fetchReels = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      
      if (!token) {
        console.info("üë§ Kullanƒ±cƒ± oturum a√ßmamƒ±≈ü - Yedek Reels verileri g√∂steriliyor");
        setReels(FALLBACK_REELS);
        setLoading(false);
        return;
      }
      
      const feedType = activeTab === 'following' ? 'following' : 'explore';
      
      const response = await secureApiRequest(() => 
        axios.get(`${API_URL}/reels?feed=${feedType}`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        })
      );
      
      if (!response) {
        setReels(FALLBACK_REELS);
        setLoading(false);
        return;
      }
      
      if (response.data.success && response.data.data.length > 0) {
        console.log('Kullanƒ±cƒ± videolarƒ± y√ºklendi:', response.data.data.length);
        
        const userReels = response.data.data.map(reel => ({
          ...reel,
          id: String(reel.id)
        }));
        
        setReels(userReels);
      } else {
        toast.error('Hen√ºz reel i√ßeriƒüi bulunamadƒ±');
        setReels(FALLBACK_REELS);
      }
    } catch (err) {
      console.error('Reels getirme hatasƒ±:', err);
      
      if (err.response && err.response.status === 401) {
        toast.error('Oturum s√ºresi doldu, l√ºtfen tekrar giri≈ü yapƒ±n');
      } else {
        setError('Reels y√ºklenirken bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
      }
      
      setReels(FALLBACK_REELS);
    } finally {
      setLoading(false);
    }
  }, [activeTab, token, secureApiRequest]);

  // Sekme deƒüi≈ütiƒüinde reelsleri g√ºncelle
  useEffect(() => {
    setCurrentReelIndex(0);
    fetchReels();
  }, [activeTab, token, fetchReels]);

  // Dokunma olaylarƒ±nƒ± i≈üle
  const handleTouchStart = (e) => {
    lastTouchY.current = e.touches[0].clientY;
    touchStartTime.current = Date.now();
  };

  const handleTouchEnd = (e) => {
    if (!lastTouchY.current) return;
    
    const touchEndY = e.changedTouches[0].clientY;
    const touchDiff = lastTouchY.current - touchEndY;
    const touchDuration = Date.now() - touchStartTime.current;
    
    // ƒ∞ki kez tetiklenme durumunu √∂nlemek i√ßin zaman kontrol ekleyelim
    const now = Date.now();
    if (now - lastScrollTime.current < 1000 || isScrolling.current) {
      lastTouchY.current = null;
      return;
    }
    
    // Kaydƒ±rma olayƒ± ba≈ülatƒ±ldƒ±ƒüƒ±nda kilitleme yapalƒ±m
    isScrolling.current = true;
    lastScrollTime.current = now;
    
    // Hƒ±zlƒ± dokunu≈ülar i√ßin daha yava≈ü tepki verelim, e≈üik deƒüerini artƒ±ralƒ±m
    const speedFactor = Math.max(0.7, Math.min(1, touchDuration / 300));
    const threshold = 70 * speedFactor; // E≈üik deƒüerini artƒ±rdƒ±k
    
    if (Math.abs(touchDiff) > threshold) {
      if (touchDiff > 0 && currentReelIndex < reels.length - 1) {
        // A≈üaƒüƒ± swipe
        setCurrentReelIndex(prevIndex => prevIndex + 1);
      } else if (touchDiff < 0 && currentReelIndex > 0) {
        // Yukarƒ± swipe
        setCurrentReelIndex(prevIndex => prevIndex - 1);
      }
      
      // Kaydƒ±rma i≈ülemi bittikten sonra 1 saniye daha beklet
      setTimeout(() => {
        isScrolling.current = false;
      }, 1000);
    } else {
      // E≈üik deƒüeri a≈üƒ±lmadƒ±ysa kilidi hemen kaldƒ±r
      isScrolling.current = false;
    }
    
    lastTouchY.current = null;
  };

  // Tekerlek olayƒ± i≈üleyicisi
  const handleWheel = useCallback((e) => {
    e.preventDefault();
    
    // Zaman kontrolleriyle kaydƒ±rma olaylarƒ±nƒ±n beklenmeyen davranƒ±≈ülarƒ±nƒ± √∂nle
    const now = Date.now();
    if (now - lastScrollTime.current < 1000 || isScrolling.current) return;
    
    // Olayƒ±n ≈üiddetini kontrol et
    const wheelDelta = Math.abs(e.deltaY);
    // √áok hafif kaydƒ±rmalar i√ßin i≈ülem yapma (kazara tetiklenmeleri √∂nle)
    if (wheelDelta < 20) return;
    
    isScrolling.current = true;
    lastScrollTime.current = now;
    
    // Mevcut kaydƒ±rma y√∂n√ºne g√∂re bir indeks deƒüi≈ütir
    if (e.deltaY > 0 && currentReelIndex < reels.length - 1) {
      setCurrentReelIndex(prev => prev + 1);
    } else if (e.deltaY < 0 && currentReelIndex > 0) {
      setCurrentReelIndex(prev => prev - 1);
    }
    
    // Kaydƒ±rma kilidini biraz daha uzun s√ºre beklet
    setTimeout(() => {
      isScrolling.current = false;
    }, 1000);
  }, [currentReelIndex, reels.length]);

  // Tekerlek olaylarƒ±nƒ± dinle
  useEffect(() => {
    const container = reelsContainerRef.current;
    if (container) {
      container.addEventListener('wheel', handleWheel, { passive: false });
      
      return () => {
        container.removeEventListener('wheel', handleWheel);
      };
    }
  }, [handleWheel]);
  
  // Klavye olaylarƒ±nƒ± dinle
  useEffect(() => {
    const handleKeyDown = (e) => {
      const now = Date.now();
      if (now - lastScrollTime.current < 1000 || isScrolling.current) return;
      
      // Sadece yukarƒ±/a≈üaƒüƒ± ok tu≈ülarƒ± i√ßin i≈ülem yap
      if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
      
      isScrolling.current = true;
      lastScrollTime.current = now;
      
      if (e.key === 'ArrowUp' && currentReelIndex > 0) {
        setCurrentReelIndex(prev => prev - 1);
      } else if (e.key === 'ArrowDown' && currentReelIndex < reels.length - 1) {
        setCurrentReelIndex(prev => prev + 1);
      }

      setTimeout(() => {
        isScrolling.current = false;
      }, 1000);
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentReelIndex, reels.length]);

  // K√º√ß√ºlt√ºlm√º≈ü sayƒ± formatƒ±
  const formatNumber = (num) => {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
  };

  // Beƒüeni i≈ülevi
  const handleLike = async (reelId) => {
    if (!token) {
      toast.error('Beƒüenmek i√ßin giri≈ü yapmanƒ±z gerekiyor');
      return;
    }
    
    // Optimistik UI g√ºncelleme
    setLikedReels(prev => ({
      ...prev,
      [reelId]: !prev[reelId]
    }));
    
    setReels(prevReels => 
      prevReels.map(reel => 
        reel.id === reelId 
          ? { 
              ...reel, 
              likeCount: likedReels[reelId] ? reel.likeCount - 1 : reel.likeCount + 1,
              isLiked: !likedReels[reelId]
            } 
          : reel
      )
    );
    
    try {
      // API ile beƒüeni i≈ülemi
      await secureApiRequest(() => 
        axios.post(`${API_URL}/reels/${reelId}/like`, {}, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        })
      );
    } catch (err) {
      console.error('Beƒüeni i≈ülemi hatasƒ±:', err);
      
      // Hata durumunda UI'ƒ± geri al
      setLikedReels(prev => ({
        ...prev,
        [reelId]: !prev[reelId]
      }));
      
      setReels(prevReels => 
        prevReels.map(reel => 
          reel.id === reelId 
            ? { 
                ...reel, 
                likeCount: likedReels[reelId] ? reel.likeCount + 1 : reel.likeCount - 1,
                isLiked: likedReels[reelId]
              } 
            : reel
        )
      );
      
      toast.error('Beƒüeni i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu');
    }
  };

  // Yorum panelini a√ß
  const handleComment = (reelId) => {
    setActiveReelId(reelId);
    setShowCommentsPanel(true);
  };

  // Payla≈üma i≈ülevi
  const handleShare = async (reelId) => {
    try {
      const shareUrl = `${window.location.origin}/reels/${reelId}`;
      
      if (navigator.share) {
        await navigator.share({
          title: 'Reel Payla≈ü',
          text: 'Bu reel ho≈üuma gitti, sence de g√ºzel mi?',
          url: shareUrl
        });
        
        toast.success('Payla≈üƒ±m ba≈üarƒ±lƒ±!');
      } else {
        // Web Payla≈üƒ±m API'si mevcut deƒüilse, URL'yi kopyala
        navigator.clipboard.writeText(shareUrl)
          .then(() => toast.success('Baƒülantƒ± kopyalandƒ±!'))
          .catch(() => toast.error('Baƒülantƒ± kopyalanamadƒ±'));
      }
      
      // Payla≈üƒ±m sayƒ±sƒ±nƒ± arttƒ±r (optimistik UI)
      setReels(prevReels => 
        prevReels.map(reel => 
          reel.id === reelId 
            ? { ...reel, shareCount: reel.shareCount + 1 } 
            : reel
        )
      );
      
      // API ile payla≈üƒ±m kaydƒ± (isteƒüe baƒülƒ±)
      await secureApiRequest(() => 
        axios.post(`${API_URL}/reels/${reelId}/share`, {}, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        })
      );
    } catch (err) {
      console.error('Payla≈üƒ±m hatasƒ±:', err);
    }
  };

  // Yorum panelini kapat
  const closeCommentsPanel = () => {
    setShowCommentsPanel(false);
    setActiveReelId(null);
  };
  
  // Giri≈ü sayfasƒ±na y√∂nlendir
  const navigateToLogin = () => {
    navigate('/login');
  };
  
  // Video y√ºkleme ba≈üarƒ±lƒ± olduƒüunda
  const handleUploadSuccess = (newReel) => {
    setReels(prevReels => [newReel, ...prevReels]);
    setCurrentReelIndex(0); // ƒ∞lk reele git
    toast.success('Yeni reel eklendi!');
  };

  return (
    <div 
      className="relative h-screen w-full overflow-hidden bg-slate-950"
      onTouchStart={handleTouchStart}
      onTouchEnd={handleTouchEnd}
      id="reels-container" 
      ref={reelsContainerRef}
    >
      {/* Toast bildirimleri */}
      <Toaster position="top-center" />
      
      {/* Sparkles Arkaplanƒ± */}
      <div className="w-full absolute inset-0 h-screen">
        {convertBooleanProps({
          component: <SparklesCore
            id="reelsBackgroundParticles"
            background="transparent"
            minSize={0.6}
            maxSize={1.4}
            particleDensity={50}
            className="w-full h-full"
            particleColor="#FFFFFF"
            speed={0.3}
            jsx="true"
            global="true"
          />
        }).component}
      </div>
      
      {/* Radyal gradient maskesi */}
      <div 
        className="absolute inset-0 w-full h-full bg-slate-950 opacity-95 [mask-image:radial-gradient(circle_at_center,transparent_10%,black)]"
        style={{ backdropFilter: "blur(3px)" }}
      ></div>

      {/* Giri≈ü gerektiren mesaj */}
      {!user && <AuthRequiredBanner onLogin={navigateToLogin} />}

      {/* Ana i√ßerik */}
      <div className="relative flex h-screen z-20">
        {/* Sol Panel */}
        <div className={`hidden md:block w-64 lg:w-72 h-full border-r border-slate-800/30 p-4 ${showCommentsPanel ? 'animate-slide-left' : ''}`}>
          <LeftPanel />
          
          {/* Tab Se√ßici */}
          <TabSelector activeTab={activeTab} setActiveTab={setActiveTab} />
          
          {/* Video Y√ºkleme Butonu */}
          <div className="bg-slate-800/50 backdrop-blur-sm rounded-xl p-3 mt-4">
            <h3 className="text-sm font-medium mb-3 text-white/70">Yeni ƒ∞√ßerik</h3>
            <button
              onClick={() => setShowUploadModal(true)}
              className="flex items-center justify-center w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-500 hover:from-purple-700 hover:to-blue-600 text-white rounded-lg transition-colors"
            >
              <Plus className="h-5 w-5 mr-2" />
              <span>Reel Olu≈ütur</span>
            </button>
          </div>
        </div>
        
        {/* Ana i√ßerik alanƒ± */}
        <div className={`flex-1 h-full ${showCommentsPanel ? 'animate-slide-left-main' : ''}`}>
          {/* Header */}
          <ReelsHeader 
            onOpenCamera={() => setShowUploadModal(true)}
            onSearchToggle={() => setShowSearchInput(!showSearchInput)}
            showSearchInput={showSearchInput}
          />
          
          {/* Reels i√ßeriƒüi */}
          <div className="flex items-center justify-center h-[calc(100vh-56px)]">
            {loading ? (
              <div className="flex flex-col items-center justify-center text-white">
                <div className="w-16 h-16 border-t-2 border-b-2 border-purple-500 rounded-full animate-spin mb-4"></div>
                <p className="text-lg">Reels y√ºkleniyor...</p>
              </div>
            ) : error ? (
              <div className="flex flex-col items-center justify-center p-8 max-w-md text-center">
                <div className="text-red-500 text-6xl mb-4">üòï</div>
                <h3 className="text-xl font-bold text-white mb-2">Bir hata olu≈ütu</h3>
                <p className="text-gray-400 mb-4">{error}</p>
                <div className="flex gap-4">
                  <button 
                    className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors"
                    onClick={() => navigate('/')}
                  >
                    Ana sayfaya d√∂n
                  </button>
                  <button 
                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors"
                    onClick={() => fetchReels()}
                  >
                    Tekrar dene
                  </button>
                </div>
              </div>
            ) : reels.length === 0 ? (
              <div className="flex flex-col items-center justify-center p-8 max-w-md text-center">
                <div className="text-yellow-500 text-6xl mb-4">ü§î</div>
                <h3 className="text-xl font-bold text-white mb-2">
                  {activeTab === 'following' 
                    ? 'Takip ettiƒüin kimsenin reeli yok' 
                    : 'Hen√ºz ke≈üfedilecek reel yok'}
                </h3>
                <p className="text-gray-400 mb-4">
                  {activeTab === 'following'
                    ? 'Daha fazla ki≈üiyi takip etmeyi veya ke≈üfet b√∂l√ºm√ºne bakmayƒ± deneyebilirsin.'
                    : 'ƒ∞lk reeli olu≈üturmak ister misin?'}
                </p>
                <div className="flex gap-4">
                  {activeTab === 'following' ? (
                    <button 
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors"
                      onClick={() => setActiveTab('explore')}
                    >
                      Ke≈üfete git
                    </button>
                  ) : (
                    <button 
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors"
                      onClick={() => setShowUploadModal(true)}
                    >
                      Reel olu≈ütur
                    </button>
                  )}
                </div>
              </div>
            ) : (
              <div className="flex items-center justify-center">
                {/* Reels alanƒ± - 9:16 oranƒ±nda container */}
                <div className="relative flex flex-row gap-8">
                  {/* Video container - TikTok tarzƒ±, daha b√ºy√ºk boyutlar */}
                  <div className="relative w-[350px] h-[620px] rounded-xl overflow-hidden bg-black md:w-[360px] md:h-[640px]">
                    {/* Yukarƒ± kaydƒ±rma indikat√∂r√º */}
                    {currentReelIndex > 0 && (
                      <motion.div 
                        className="absolute top-2 left-1/2 transform -translate-x-1/2 z-30 bg-slate-900/60 backdrop-blur-sm px-3 py-1.5 rounded-full flex items-center"
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -10 }}
                      >
                        <ChevronUp className="h-4 w-4 text-white mr-1.5" />
                        <span className="text-white text-xs">Yukarƒ± kaydƒ±r</span>
                      </motion.div>
                    )}
                    
                    {/* Reels */}
                    {reels.map((reel, index) => (
                      <div 
                        key={reel.id}
                        className={`absolute inset-0 transition-all duration-500 ${
                          index === currentReelIndex 
                            ? 'opacity-100 z-20 transform-none' 
                            : index < currentReelIndex 
                              ? 'opacity-0 z-10 transform -translate-y-full' 
                              : 'opacity-0 z-10 transform translate-y-full'
                        }`}
                      >
                        {/* Video oynatƒ±cƒ± */}
                        <ReelsVideoPlayer 
                          video={reel} 
                          isActive={index === currentReelIndex}
                        />
                        
                        {/* Video bilgileri (caption, username, vb.) */}
                        <div className="absolute bottom-20 left-4 right-20 z-30">
                          <h4 className="text-white font-bold flex items-center text-lg">
                            {reel.user.username}
                            <span className="ml-2 text-sm bg-blue-500 text-white px-1.5 py-0.5 rounded-full text-[10px] font-medium">Takip Et</span>
                          </h4>
                          <p className="text-white text-sm mt-1.5">{reel.caption}</p>
                          <div className="flex items-center mt-2 text-white/80 text-xs">
                            <div className="flex items-center">
                              <svg className="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                              </svg>
                              <span className="truncate max-w-[200px]">{reel.music}</span>
                            </div>
                          </div>
                        </div>
                        
                        {/* Mobil ekranlarda (md breakpoint altƒ±nda) i√ßerideki kontrol butonlarƒ± */}
                        <div className="absolute bottom-16 right-3 z-30 md:hidden">
                          <VideoControls 
                            reel={reel} 
                            onLikeClick={handleLike}
                            onCommentClick={handleComment}
                            onShareClick={handleShare}
                            isLiked={likedReels[reel.id] || reel.isLiked}
                            formatNumber={formatNumber}
                          />
                        </div>
                      </div>
                    ))}
                    
                    {/* A≈üaƒüƒ± kaydƒ±rma indikat√∂r√º */}
                    {currentReelIndex < reels.length - 1 && (
                      <motion.div 
                        className="absolute bottom-2 left-1/2 transform -translate-x-1/2 z-30 bg-slate-900/60 backdrop-blur-sm px-3 py-1.5 rounded-full flex items-center"
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: 10 }}
                      >
                        <ChevronDown className="h-4 w-4 text-white mr-1.5" />
                        <span className="text-white text-xs">A≈üaƒüƒ± kaydƒ±r</span>
                      </motion.div>
                    )}
                  </div>
                  
                  {/* Masa√ºst√º ekranlarda (md breakpoint √ºst√ºnde) dƒ±≈üarƒ±daki kontrol butonlarƒ± */}
                  {reels.length > 0 && (
                    <div className="hidden md:flex items-center">
                      <VideoControls 
                        reel={reels[currentReelIndex]} 
                        onLikeClick={handleLike}
                        onCommentClick={handleComment}
                        onShareClick={handleShare}
                        isLiked={likedReels[reels[currentReelIndex].id] || reels[currentReelIndex].isLiked}
                        formatNumber={formatNumber}
                      />
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* Yorumlar paneli */}
        <CommentsPanel 
          isVisible={showCommentsPanel}
          reelId={activeReelId}
          onClose={closeCommentsPanel}
        />
      </div>
      
      {/* Video y√ºkleme modali */}
      <VideoUploader 
        isOpen={showUploadModal}
        onClose={() => setShowUploadModal(false)}
        onSuccess={handleUploadSuccess}
        secureApiRequest={secureApiRequest}
      />
    </div>
  );
};

export default Reels;